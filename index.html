<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'/>
		<meta http-equiv='X-UA-Compatible' content='IE=edge'/>
		<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
		<title>DUCO Monitor | by siunusdev.com</title>
		<meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'/>
		<link rel='stylesheet' href='plugins/bootstrap/dist/css/bootstrap.min.css'/>
		<link rel='stylesheet' href='plugins/font-awesome/css/font-awesome.min.css'/>
		<link rel='stylesheet' href='dist/css/AdminLTE.min.css'/>
		<link rel='stylesheet' href='dist/css/skins/_all-skins.min.css'/>
		<link rel='stylesheet' href='dist/css/axkjfkdfhk.css'/>
		<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic'/>
		
		<!--[if lt IE 9]>
		<script src='https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js'></script>
		<script src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js'></script>
		<![endif]-->
	</head>
	<body class='hold-transition skin-blue layout-top-nav'>

		<div class='wrapper'>

			<header class="main-header">
				<nav class="navbar navbar-static-top">
					<div class="container">
						<div class="navbar-header">
							<a href="" class="navbar-brand"><b>DUCO</b>Monitor</a>
							<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
								<i class="fa fa-bars"></i>
							</button>
						</div>

						<div class="collapse navbar-collapse pull-left" id="navbar-collapse">
							<ul class="nav navbar-nav">
								<li class="active"><a href="/">Monitor <span class="sr-only">(current)</span></a></li>
								<li><a href="https://revoxhere.github.io/duco-exchange/" target='_blank'>DUCO Exchange</a></li>
								<li><a href="http://www.node-s.co.za/duco_exchange/home" target='_blank'>Node-S Exchange</a></li>
							</ul>
						</div>
						
						<div class="navbar-custom-menu">
							<ul class="nav navbar-nav">
								
								<li class="dropdown messages-menu">
									
									<a href="#" class="dropdown-toggle">
										<i class="fa fa-clock-o"></i> <span id='time-bar'>00:00:00</span>
									</a>
								</li>
								
								<li class="dropdown user user-menu">
									<!-- Menu Toggle Button -->
									<a href="#" class="dropdown-toggle" data-toggle="dropdown">
										<!-- The user image in the navbar-->
										<img src="dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
										<!-- hidden-xs hides the username on small devices so only the image appears. -->
										<span class="hidden-xs" id="duco-user">&nbsp;</span>
									</a>
									<ul class="dropdown-menu">
										<!-- The user image in the menu -->
										<li class="user-header">
											<img src="dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">

											<p>
												<small>Change duco username by adding hash #username to url</small>
											</p>
										</li>
									</ul>
								</li>
							</ul>
						</div>
						<!-- /.navbar-custom-menu -->
					</div>
					<!-- /.container-fluid -->
				</nav>
			</header>

			<!-- Content Wrapper. Contains page content -->
			<div class="content-wrapper">
				<div class="container">
					<!-- Content Header (Page header) -->
					<section class="content-header hidden-lg hidden-md hidden-sm">
						<ol class="breadcrumb">
							<li><a href="#"><i class="fa fa-database"></i> CPU: <span id='stat-cpu'>-</span></a></li>
							<li><a href="#">RAM: <span id='stat-ram'>-</span></a></li>
							<li><a href="#">Active Connections: <span id='stat-conn'>-</span></a></li>
						</ol>
					</section>

					<!-- Main content -->
					<section class="content">
				
						<div class="row">
							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-aqua"><i class="fa fa-sitemap"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">Active Workers</span>
										<span class="info-box-number"><span id='counter-worker'>-</span></span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->
							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-red"><i class="fa fa-dollar"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">DUCO Price</span>
										<span class="info-box-number"><span id='counter-price'>-</span></span>
										<span class="info-box-text"><span id='counter-price-change'>-</span></span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->

							<!-- fix for small devices only -->
							<div class="clearfix visible-sm-block"></div>

							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-green"><i class="fa fa-money"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">Estimated Profit</span>
										<span class="info-box-number"><span id='counter-estprofit'>-</span></span>
										<span class="info-box-text">24 Hours</span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->
							<div class="col-md-3 col-sm-6 col-xs-12">
								<div class="info-box">
									<span class="info-box-icon bg-yellow"><i class="fa fa-money"></i></span>

									<div class="info-box-content">
										<span class="info-box-text">DUCO Balance</span>
										<span class="info-box-number"><span id='counter-balance'>-</span></span>
										<span class="info-box-text"><span id='counter-dollar'></span></span>
									</div>
									<!-- /.info-box-content -->
								</div>
								<!-- /.info-box -->
							</div>
							<!-- /.col -->
						</div>
						
						<div class='row'>
							<div class='col-md-12'>
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-line-chart fa-fw'></i> &nbsp;Price Chart</h3>
									</div>
									<div class="box-body">
										<canvas id='priceChart' style='height:250px;width:100%;'></canvas>
									</div>
								</div>
							</div>
						</div>
						
						<div class='row'>
							<div class='col-md-6'>
							
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-diamond fa-fw'></i> &nbsp;Miners</h3>
									</div>
									<!-- /.box-header -->
									<div class="box-body table-responsive no-padding">
										<table class='table' id='tbl-miners'>
											<thead>
												<tr>
													<th width='20px'>#</th>
													<th>Software</th>
													<th>Accepted</th>
													<th>Rejected</th>
													<th>Hashrate</th>
													<th>Diff</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td></td>
													<td>Loading...</td>
													<td></td>
													<td></td>
													<td></td>
													<td></td>
												</tr>
											</tbody>
										</table>
									</div>
									<!-- /.footer -->
								</div>
								<!-- /.box -->
							
							</div>
							<div class='col-md-6'>
							
								<div class="box box-solid">
									<div class="box-header with-border">
										<h3 class="box-title"><i class='fa fa-fw fa-trophy'></i> &nbsp;Top 10</h3>
									</div>
									<!-- /.box-header -->
									<div class="box-body table-responsive no-padding">
										<table class='table' id='tbl-top10'>
											<thead>
												<tr>
													<th width='20px'>#</th>
													<th>Balance</th>
													<th>Username</th>
													<th>Workers</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td></td>
													<td>Loading...</td>
													<td></td>
												</tr>
											</tbody>
										</table>
									</div>
									<!-- /.footer -->
								</div>
								<!-- /.box -->
						</div>
						
					</section>
				<!-- /.content -->
				</div>
			</div>
			
			<footer class="main-footer">
				<div class="container">
					<div class="pull-right hidden-xs">
						<a href="https://www.github.com/siunus" title='Github' target='_blank'><i class='fa fa-github text-black'></i></a> &nbsp;&nbsp;&nbsp; 
						<a href="https://www.instagram.com/siunus_id" title='Follow me on Instagram' target='_blank'><i class='fa fa-instagram text-red'></i></a> 
					</div>
					<a href="https://www.siunusdev.com" title='My Website' target='_blank'>SIUNUSDEV</a> &nbsp;&middot;&nbsp; 
					<a href="https://duinocoin.com" title='Duino-Coin' target='_blank'>Duino-Coin</a> &nbsp;&middot;&nbsp; 
					<a href="https://adminlte.io" title='Theme' target='_blank'>AdminLTE</a>
				</div>
				<!-- /.container -->
			</footer>
			
		</div>
		
		<script src='plugins/jquery/dist/jquery.min.js'></script>
		<script src='plugins/bootstrap/dist/js/bootstrap.min.js'></script>
		<script src='plugins/chart.js/Chart.min.js'></script>
		<script src='dist/js/adminlte.min.js'></script>
		<script defer>
			var username = "siunusdev";
			var ducoPrice = 0;
			var lastPrice = 0;
			var lastBalance = 0;
			var lastCounter = 0;
			var isStopped = false;
			
			if(location.hash != "") {
				username = location.hash.replaceAll("#", "");
				setUsername(username);
			}
			
			window.onhashchange = function() {
				username = location.hash.replaceAll("#", "");
				setUsername(username);
				
				lastBalance = 0;
				lastCounter = 0;
				
				getJsonData();
				getBalanceData();
			}
			
			var chartConfig = {
				type: 'line',
				data: {
					labels: ["-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-", "-:-"],
					datasets: [
						{
							label: '$',
							backgroundColor : 'rgba(221, 75, 57, 0.1)',
							borderColor : '#dd4b39',
							borderWidth : 2,
							pointRadius : 1,
							pointHoverRadius : 6,
							pointHitRadius : 10,
							data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
						}
					]
				},
				options: {
					responsive: true,
					legend: {
						display: false
					}
				}
			};

			var chartContext = document.getElementById('priceChart').getContext('2d');
			window.priceChart = new Chart(chartContext, chartConfig);
			
			function setUsername(u) {
				$('#duco-user').text(u);
			}
			
			function addZero(n) {
				if(n < 10) {
					return "0" + n;
				} else {
					return n;
				}
			}
			
			function setTimebar() {
				var date = new Date();
				var h = date.getHours();
				var m = date.getMinutes();
				var s = date.getSeconds();
				
				$('#time-bar').text(addZero(h) + ":" + addZero(m) + ":" + addZero(s));
				
				setTimeout(setTimebar, 1000);
			}
			
			function updatePriceChart(newLabel, newValue) {
				var chartDataLen = chartConfig.data.datasets[0].data.length;
				var chartDataLast = chartConfig.data.datasets[0].data[chartDataLen - 1];
				
				if(newValue != chartDataLast) {
					chartConfig.data.labels.push(newLabel);
					chartConfig.data.datasets[0].data.push(newValue);
					
					if(chartDataLen > 15) {
						chartConfig.data.labels.shift();
						chartConfig.data.datasets[0].data.shift();
					}
					
					window.priceChart.update();
				}
			}
			
			function getJsonData() {				
				$.ajax({
					beforeSend: function(request) {
						request.setRequestHeader("X-Requested-With", navigator.userAgent);
					},
					dataType: "json",
					url: "https://dev.siunusdev.com/duco/api.php"
				})
				.done(function(data) {
					var statCPU = data["Server CPU usage"];
					var statRAM = data["Server RAM usage"];
					var statConn = data["Active connections"];
					var ctrWorker = data["Active workers"][username];
					var ctrPrice = data["Duco price"];
					var tblMiners = $('#tbl-miners tbody');
					var tblTop10 = $('#tbl-top10 tbody');
					var myMiners = [];
					var date = new Date();
					
					ctrPrice = ctrPrice.toFixed(6);
					ducoPrice = ctrPrice;
					
					updatePriceChart(addZero(date.getHours()) + ":" + addZero(date.getMinutes()), ctrPrice);
					
					$('#stat-cpu').text(statCPU + "%");
					$('#stat-ram').text(statRAM + "%");
					$('#stat-conn').text(statConn);
					$('#counter-worker').text(ctrWorker);
					$('#counter-price').html(ctrPrice + " <small>$</small>");
					
					var ctrPriceChange = (ctrPrice - lastPrice);
					if(ctrPriceChange != 0) {
						if(ctrPriceChange != ctrPrice) {
							if(ctrPriceChange > 0) {
								$('#counter-price-change').html("<span class='text-green'><i class='fa fa-caret-up'></i> &nbsp; " + ctrPriceChange.toFixed(6) + " $</span>");
							} else {
								$('#counter-price-change').html("<span class='text-red'><i class='fa fa-caret-down'></i> &nbsp; " + ctrPriceChange.toFixed(6) + " $</span>");
							}
							
							
						}
						lastPrice = ctrPrice;
					}
					
					for (process in data["Miners"]) {
						if (data["Miners"][process]["User"].includes(username)) {
							myMiners.push(data["Miners"][process]);
						}
					}
					
					tblMiners.text('');
					for(miner in myMiners) {
						var tblHTML = "<tr>";
						tblHTML = tblHTML + "<td>" + (+miner+1) + "</td>";
						tblHTML = tblHTML + "<td>" + myMiners[miner]["Software"] + "</td>";
						tblHTML = tblHTML + "<td class='text-green'>" + myMiners[miner]["Accepted"] + "</td>";
						tblHTML = tblHTML + "<td class='text-red'>" + myMiners[miner]["Rejected"] + "</td>";
						tblHTML = tblHTML + "<td class='text-yellow'>" + myMiners[miner]["Hashrate"] + "</td>";
						tblHTML = tblHTML + "<td>" + myMiners[miner]["Diff"] + "</td>";
						tblHTML = tblHTML + "</tr>";
						
						tblMiners.append(tblHTML);
					}
					
					tblTop10.text('');
					for(position in data["Top 10 richest miners"]) {
						var pos = data["Top 10 richest miners"][position].replaceAll("DUCO", "ᕲ").split("-");
						var topBalance = pos[0].trim();
						var topUsername = pos[1].trim();
						var topWorkers = data["Active workers"][topUsername];
						
						if(topWorkers == undefined) {
							topWorkers = 0;
						}
						
						tblTop10.append("<tr><td>" + (+position+1) + "</td><td>" + topBalance + "</td><td><a href='#" + topUsername + "'>" + topUsername + "</a></td><td>" + topWorkers + "</td></tr>");
					}
				})
				.fail(function(err) {
					console.log('getJsonData', err);
				})
				.always(function() {
					if(!isStopped) {
						setTimeout(getJsonData, 11000);
					}
				});
			}
			
			function getBalanceData() {
				$.ajax({
					beforeSend: function(request) {
						request.setRequestHeader("X-Requested-With", navigator.userAgent);
					},
					dataType: "json",
					url: "https://dev.siunusdev.com/duco/balances.php"
				})
				.done(function(data) {
					var ctrBalance = data[username];
					var balanceStr = ctrBalance.split(" ");
					var balance = +balanceStr[0];
					var ctrDollar = balance * ducoPrice;
					
					$('#counter-balance').html(balance.toFixed(4) + " <small>ᕲ</small>");
					$('#counter-dollar').text("~" + ctrDollar.toFixed(2) + " $");
					
					if(balance > lastBalance) {
						var newCounter = new Date().getTime() / 1000;
						var changedInSec = 3600 / (newCounter - lastCounter);
						var estInHours = (balance - lastBalance) * changedInSec;
						var ctrEstimated = estInHours * 24;
					
						if(lastBalance == 0) {
							$('#counter-estprofit').html("<small>Calculating...</small>");
						} else {
							$('#counter-estprofit').html("~" + ctrEstimated.toFixed(4) + " <small>ᕲ</small>");
						}
						
						lastBalance = balance;
						lastCounter = newCounter;
					}
				})
				.fail(function(err) {
					console.log('getBalanceData', err);
				})
				.always(function() {
					if(!isStopped) {
						setTimeout(getBalanceData, 5000);
					}
				});
			}
			
			$(document).ready(function() {
				setUsername(username);
				setTimebar();
				getJsonData();
				getBalanceData();
			});
			
		</script>
	</body>
</html>
